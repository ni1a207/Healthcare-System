# Auth Service

## Назначение
Сервис аутентификации и авторизации. Выполняет проверку учетных данных пользователей, генерацию подписанных JWT-токенов и верификацию токенов для внешних компонентов системы (API Gateway).

## Архитектурная схема (C4 Container)
![AuthServiceC4.svg](..%2FDiagrams%2FAuthServiceC4.svg)
*Примечание: На схеме отображены только прямые интеграции сервиса.*
## Стек технологий

* **Runtime**: Java 21 (OpenJDK).
* **Framework**: Spring Boot 3.4.1 (Security, Data JPA, Validation).
* **Token Management**: JJWT 0.12.6.
* **Database**: PostgreSQL (Runtime), H2 (In-memory/Test).
* **Build Tool**: Maven 3.9.9.
* **Infrastructure**: Docker.
* **Documentation**: Springdoc OpenAPI 2.6.0.
* **Logging**: SLF4J.

## Безопасность и контроль доступа

**Шифрование паролей**: Используется BCrypt. Хранение осуществляется в виде хэшей.

**JWT**:

Алгоритм подписи: HMAC SHA (ключ декодируется из Base64).

Payload:

  * sub: Email пользователя.

  * role: Роль пользователя (строка).

  * exp: 10 часов с момента выдачи.

**Контроль доступа**: Сервис настроен на permitAll(). Ограничение доступа к эндпоинтам авторизации не требуется, так как валидация происходит внутри бизнес-логики (AuthService).

### Ролевая модель

В сервисе реализована ролевая модель управления доступом. Передаются внутри JWT-токена в поле role.

| Роль | Область доступа |
|:-----|:----------------|
| **USER** |  Базовый доступ. |
| **ADMIN** | Расширенный доступ (настроен в data.sql для тестового аккаунта). |

### База данных: auth_db
#### Таблица: users

| Название     | Обяз. | Тип | Ограничения | Описание | Пример           |
|:-------------| :--- | :--- | :--- | :--- |:-----------------|
| **id**       | Да | UUID | PK| Идентификатор пользователя | 1                |
| **email**    | Да | VARCHAR(255) | Unique, Not Null | Логин пользователя (Email) | admin@clinic.com |
| **password** | Да | VARCHAR(255) | Not Null | Хэш пароля (BCrypt) | $2a$10$v...      |
| **role**     | Да | VARCHAR(50) | Not Null | Список ролей (права доступа) | ADMIN            |

## API 
### REST 

| Метод | Полный путь (через Gateway) | Описание                                      |
|:------|:----------------------------|:----------------------------------------------|
| POST  | /auth/login                 | Аутентификация пользователя. Генерация JWT.   |
| GET   | /auth/validate              | Валидация JWT при внешних запросах к системе. |

## Переменные окружения
### Application (auth-service)
| Переменная | Значение                                  | Описание                                    |
| :--- |:------------------------------------------|:--------------------------------------------|
| **SERVER_PORT** | 4005                                      |Порт сервиса
| **SPRING_DATASOURCE_URL** | jdbc:postgresql://auth-service-db:5432/db | URL для подключения к PostgreSQL            |
| **SPRING_DATASOURCE_USERNAME** | admin_user                                | Имя пользователя базы данных                |
| **SPRING_DATASOURCE_PASSWORD** | password                                  | Пароль пользователя базы данных             |
| **SPRING_JPA_HIBERNATE_DDL_AUTO** | update                                    | Автоматическое обновление схемы базы данных |
| **SPRING_SQL_INIT_MODE** | always                                    | Выполнение data.sql при каждом запуске      |

### Database (auth-service-db)
| Переменная | Значение   | Описание                          |
| :--- |:-----------|:----------------------------------|
| **POSTGRES_DB** | db         | Название создаваемой схемы        |
| **POSTGRES_USER** | admin_user | Корневой пользователь базы данных |
| **POSTGRES_PASSWORD** | password   | Пароль корневого пользователя     |

## Сетевые параметры

| Параметр | Значение             | Описание |
| :--- |:---------------------| :--- |
| **Service Name** | auth-service         | Имя хоста в Docker-сети |
| **Internal Port** | 4005                 | Входящий HTTP порт (server.port) |
| **Target DB Host** | auth-service-db:5432 | Адрес подключения к PostgreSQL |
## Swagger
 Интерфейс | URL                                   | Описание |
| :--- |:--------------------------------------| :--- |
| **Swagger UI** | http://localhost:4005/swagger-ui.html | Локальный UI документации |
| **OpenAPI JSON** | http://localhost:4005/v3/api-docs     | Спецификация API в формате JSON |