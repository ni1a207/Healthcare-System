# Endpoint `GET {host}/validate`

## Общая информация
**Назначение:** Валидация токена для запросов к защищенным ресурсам системы.

**Метод:** GET

**Внутренний URL:** `http://auth-service:4005/validate`

**Внешний URL:** `http://{gateway-host}/auth/validate`

---

## Входные и выходные параметры
<details>
<summary><span style="color: #2E86C1;"><b>Входные параметры</b></span></summary>
Header:

| Параметр | Тип данных | Обязательность | Описание | Значение/пример | Маппинг с auth_db |
|:------|:-----------|:---------------|:---------|:-----------------|:------------------|
|Authorization|string|да|Bearer <token>| Bearer eyJhbGciOiJIUzI1NiJ9... | - |

</details>

---

## Примеры запроса и ответа

Запрос:
~~~ 
curl -X GET "{host}/validate" \
-H "Authorization: Bearer <token>"
~~~

Ответ:
~~~
Response code : 200 OK
~~~

<details>
<summary><span style="color: #2E86C1;"><b>Варианты возвращаемых HTTP статус кодов</b></span></summary>

| Код | Статус | Сообщение | Описание                                                                                                                                                                                 |
|:---|:---|:---|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 200 | OK | - | Токен валиден. Успешно пройдены проверки структуры, криптографической подписи и срока действия.                                                                                          |
| 401 | UNAUTHORIZED | - | Ошибка заголовка или валидации. Заголовок отсутствует, не содержит префикс "Bearer " или библиотека JJWT выбросила исключение (неверная подпись, истекший срок, поврежденная структура). |
| 500 | INTERNAL SERVER ERR | - | Критическая ошибка. Непредвиденный системный сбой при обработке запроса или ошибка инициализации секретного ключа.                                                                       |

</details>

---

## Алгоритм работы

1. `auth-service` получает запрос `GET /validate` с заголовком `Authorization`.


2. `auth-service` проверяет наличие и формат заголовка. Если заголовок отсутствует или не начинается с префикса `Bearer ` — сервис возвращает статус-код `401 UNAUTHORIZED`.


3. `auth-service`извлекает строку токена и передает её во внутренний метод валидации. С помощью библиотеки `JJWT` выполняются следующие последовательные проверки:

   3.1. **Проверка структуры:** Проверяется, что токен состоит из трех частей: Header, Payload, Signature, разделенных точками. Если формат нарушен — сервис идентифицирует ошибку структуры.

   3.2. **Проверка подписи:** Сервис берет Header и Payload из полученного токена и заново вычисляет хеш-сумму, используя секретный ключ (декодированный из Base64 при старте приложения). Если вычисленный хеш не совпадает с Signature в токене — сервис идентифицирует ошибку подписи.

   3.3. **Проверка срока действия:** Из Payload извлекается значение клейма expiration. Сервис сравнивает его с текущим временем сервера. Если время сервера больше — сервис идентифицирует ошибку срока действия.

Если в процессе парсинга (шаг 3) выброшено любое исключение, наследуемое от `JwtException` - сервис перехватывает его и возвращает статус-код `401 UNAUTHORIZED`.

4. При успешном завершении всех проверок `auth-service` возвращает ответ `200 OK`.

Если в процессе выполнения метода возникает критический сбой, не связанный с данными токена (например, ошибка конфигурации секретного ключа или нехватка памяти сервера) — сервис возвращает статус-код `500 INTERNAL SERVER ERROR`.

---

![GET.validate.svg](..%2FDiagrams%2FGET.validate.svg)