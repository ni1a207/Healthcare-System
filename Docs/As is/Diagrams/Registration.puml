@startuml
title Регистрация пациента и создание счета (Sequence Diagram)

autonumber

actor "User" as Client
participant "API Gateway" as Gateway
participant "Auth Service" as Auth
database "auth-db" as AuthDB
participant "Patient Service" as Patient
database "patient-db" as PatientDB
participant "Billing Service (gRPC)" as Billing
queue "Kafka (patient-events)" as Kafka

Client -> Gateway : POST /api/v1/patients (JWT в заголовке)
activate Gateway

Gateway -> Auth : GET /api/v1/auth/validate (JWT в query)
activate Auth
alt JWT отсутствует или пустой
    Auth --> Gateway : 400 Bad Request
    Gateway --> Client : 400 Bad Request
else JWT предоставлен
    Auth -> AuthDB : Поиск пользователя по username
    AuthDB --> Auth : Данные пользователя / null
    alt Токен невалиден / просрочен / пользователь не найден
        Auth --> Gateway : 401 Unauthorized
        Gateway --> Client : 401 Unauthorized
    else Успешная валидация
        Auth --> Gateway : 200 OK + JSON
    end
end
deactivate Auth

alt Инстансы Patient Service отсутствуют в Eureka
    Gateway --> Client : 503 Service Unavailable
else Пересылка запроса в Patient Service
    Gateway -> Patient : Proxy Request
    activate Patient

    alt Входные параметры невалидны
        Patient --> Client : 400 Bad Request
    end

    note over Patient, PatientDB : Начало транзакции (@Transactional)

    Patient -> PatientDB : Проверка существования email
    alt Email уже существует
        Patient --> Client : 400 Bad Request
    else Email свободен
        Patient -> PatientDB : Сохранение записи (Save Entity)
        PatientDB --> Patient : patientId (UUID)
    end

    group Интеграция с Billing (gRPC)
        Patient -> Billing : gRPC CreateBillingAccount(patientId, name, email)
        activate Billing
        alt Billing Service недоступен / ошибка
            Billing --[#red]> Patient : StatusRuntimeException
            Patient --[#red]> Client : 500 Internal Server Error
            note over Patient, PatientDB : **Rollback транзакции**
        else Успех
            Billing --> Patient : BillingResponse (accountId: "12345")
        end
        deactivate Billing
    end

    group Публикация в Kafka
        Patient -> Kafka : Отправка PatientEvent (patientEventSupplier-out-0)
        alt Kafka недоступен
            Kafka --[#red]> Patient : Exception
            Patient --[#red]> Client : 500 Internal Server Error
            note over Patient, PatientDB : **Rollback транзакции**
        end
    end

    Patient --> Client : 201 Created + JSON (Профиль пациента)
    note over Patient, PatientDB : Фиксация (Commit) транзакции
    deactivate Patient
end

deactivate Gateway

@enduml